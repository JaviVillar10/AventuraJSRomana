<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: main.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: main.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* src/main.js */

import { DATOS_JUGADOR, LISTA_ENEMIGOS, MERCADO_PRODUCTOS, PUNTOS_PARA_VETERANO, REGEX } from './constants.js';
import { formatearPrecio, obtenerAleatorio, esperar } from './utils.js';
import { Jugador } from './classes/Jugador.js';
import { Enemigo, Jefe } from './classes/Enemigo.js';
import { Producto } from './classes/Producto.js';

/**
 * L칍GICA PRINCIPAL DEL JUEGO
 * Gestiona el flujo entre escenas, la l칩gica del mercado, el sistema de batalla y el estado global.
 * @module main
 */


let jugador;
let enemigos = [];
let enemigoActualIndex = 0;

/**
 * Funci칩n para actualizar visualmente el monedero en el footer.
 * Sincroniza el valor de jugador.dinero con el elemento #tr.
 */
const refrescarDineroVisual = () => {
    const elTr = document.getElementById('tr');
    if (elTr) {
        elTr.textContent = jugador.dinero;
    }
    const elGasto = document.getElementById('gasto-total');
    if (elGasto) {
        elGasto.textContent = jugador.dinero;
    }
};

/**
 * Funci칩n de inicializaci칩n principal.
 * Se ejecuta cuando el DOM ha terminado de cargar.
 * Instancia al jugador, prepara los enemigos y configura los eventos de la interfaz.
 */
const init = () => {
    jugador = new Jugador(
        DATOS_JUGADOR.nombre,
        DATOS_JUGADOR.imagen,
        DATOS_JUGADOR.vidaBase,
        DATOS_JUGADOR.ataqueBase,
        DATOS_JUGADOR.defensaBase
    );
    
    
    jugador.dinero = 500;
    
    refrescarDineroVisual();

    enemigos = LISTA_ENEMIGOS.map(datos => {
        if (datos.esJefe) {
            return new Jefe(datos.nombre, datos.imagen, datos.vida, datos.ataque, datos.multiplicador);
        } else {
            return new Enemigo(datos.nombre, datos.imagen, datos.vida, datos.ataque);
        }
    });

    asignarEventosBotones();
    actualizarInfoJugadorInicio();
    sembrarRankingFicticio();
    renderizarInventarioUI();
};

/**
 * Asigna los listeners a todos los botones de la interfaz.
 */
const asignarEventosBotones = () => {
    document.getElementById('btn-ir-mercado').addEventListener('click', () => {
        cargarMercado();
        cambiarEscena('escena-mercado');
    });

    document.getElementById('btn-mercado-continuar').addEventListener('click', () => {
        mostrarEstadoFinal();
        cambiarEscena('escena-estado');
    });

    document.getElementById('btn-ver-enemigos').addEventListener('click', () => {
        mostrarGaleriaEnemigos();
        cambiarEscena('escena-enemigos');
    });

    document.getElementById('btn-comenzar-batalla').addEventListener('click', () => {
        iniciarSistemaBatallas();
        cambiarEscena('escena-batalla');
    });

    document.getElementById('btn-siguiente-batalla').addEventListener('click', () => {
        siguienteRonda();
    });

    document.getElementById('btn-reiniciar').addEventListener('click', () => {
        location.reload();
    });


    document.getElementById('btn-ir-inicio').addEventListener('click', () => {
        const formulario = document.getElementById('crear-personaje');
        const errNom = document.getElementById('error-nombre');
        const errStat = document.getElementById('error-stats');

        errNom.textContent = "";
        errStat.textContent = "";

        const nombre = formulario.elements['nombre-jugador'].value.trim();
        const atkVal = parseInt(formulario.elements['ataque'].value);
        const defVal = parseInt(formulario.elements['defensa'].value);
        const vidVal = parseInt(formulario.elements['vida'].value);

        let errores = false;

        if (!REGEX.NOMBRE_GLADIADOR.test(nombre)) {
            errNom.textContent = "La primera letra debe ser May칰scula (m치x 20 carac).";
            errores = true;
        }

        if (atkVal &lt; 0 || defVal &lt; 0) {
        errStat.textContent = "El ataque y la defensa no pueden ser valores negativos.";
        errores = true;
    }

        if (vidVal &lt; 100) {
            errStat.textContent = "La vida no puede ser inferior a 100 puntos.";
            errores = true;
        } else if ((atkVal + defVal + vidVal) > 110) {
            errStat.textContent = "Total excedido. Solo puedes repartir 10 puntos extra.";
            errores = true;
        }

        if (!errores) {
            jugador.nombre = nombre;
            jugador.ataqueBase = atkVal;
            jugador.defensaBase = defVal;
            jugador.vida = vidVal;
            jugador.vidaMaxima = vidVal;

            actualizarInfoJugadorInicio();
            cambiarEscena('escena-inicio');
        }
    });

    const btnRanking = document.getElementById('btn-ir-ranking-escena');
    if (btnRanking) {
        btnRanking.addEventListener('click', () => {
            mostrarRankingEnPantalla();
            cambiarEscena('escena-ranking');
        });
    }

    const btnTerminal = document.getElementById('btn-mostrar-terminal');
    if (btnTerminal) {
        btnTerminal.addEventListener('click', () => {
            const ranking = JSON.parse(localStorage.getItem('ranking_gladiadores')) || [];
            ranking.sort((a, b) => b.puntuacionTotal - a.puntuacionTotal);
            console.log("%c--- RANKING T칄CNICO (TERMINAL) ---", "color: gold; font-weight: bold;");
            console.table(ranking);
        });
    }
};

/**
 * Controla la visibilidad de las escenas del juego.
 * @param {string} idEscena - El ID del elemento HTML de la escena a mostrar.
 */
const cambiarEscena = (idEscena) => {
    const escenas = document.querySelectorAll('.escena');
    escenas.forEach(escena => {
        if (escena.id === idEscena) {
            escena.classList.remove('oculta');
            escena.classList.add('visible');
        } else {
            escena.classList.add('oculta');
            escena.classList.remove('visible');
        }
    });
};

/**
 * Actualiza los datos del jugador en la escena de inicio/bienvenida.
 */
function actualizarInfoJugadorInicio() {
    document.getElementById('nombre-jugador').textContent = jugador.nombre;
    document.getElementById('vida-jugador').textContent = jugador.vida;
    document.getElementById('ataque-jugador').textContent = jugador.ataqueBase;
    document.getElementById('defensa-jugador').textContent = jugador.defensaBase;
    document.getElementById('img-jugador-inicio').src = jugador.imagen;
    
    const imgRes = document.getElementById('img-jugador-inicio-resumen');
    if(imgRes) imgRes.src = jugador.imagen;

    refrescarDineroVisual();
}

/**
 * Carga y renderiza los productos en la escena del mercado.
 */
const cargarMercado = () => {
    refrescarDineroVisual();
    const contenedor = document.getElementById('contenedor-productos');
    contenedor.innerHTML = '';

    const rarezas = ['comun', 'rara', 'legendaria'];
    const rarezaConDescuento = rarezas[obtenerAleatorio(0, rarezas.length - 1)];
    const porcentajeDescuento = obtenerAleatorio(10, 50);

    MERCADO_PRODUCTOS.forEach(datosProd => {
        let productoObj = new Producto(
            datosProd.nombre, datosProd.imagen, datosProd.precio, 
            datosProd.tipo, datosProd.bonus, datosProd.rareza
        );

        if (productoObj.rareza === rarezaConDescuento) {
            productoObj = productoObj.aplicarDescuento(porcentajeDescuento);
        }

        const tarjetaDiv = document.createElement('div');
        tarjetaDiv.className = 'ficha-producto';
        
        tarjetaDiv.innerHTML = `
            &lt;img src="${productoObj.imagen}" alt="${productoObj.nombre}">
            &lt;h4>${productoObj.nombre}&lt;/h4>
            &lt;p>+${productoObj.bonus} (${productoObj.tipo})&lt;/p>
            &lt;p class="precio">${formatearPrecio(productoObj.precio)}&lt;/p>
            &lt;button class="btn-comprar">Comprar&lt;/button>
        `;

        const btn = tarjetaDiv.querySelector('.btn-comprar');
        if (jugador.inventario.some(p => p.nombre === productoObj.nombre)) {
             btn.textContent = "Retirar";
             btn.classList.add('btn-retirar');
             tarjetaDiv.style.backgroundColor = "#c8e6c9";
        }

        btn.addEventListener('click', () => {
            gestionarCompra(productoObj, btn, tarjetaDiv);
        });

        contenedor.appendChild(tarjetaDiv);
    });
};

/**
 * Gestiona la l칩gica de compra y devoluci칩n de objetos.
 * @param {Producto} producto - El objeto seleccionado.
 * @param {HTMLButtonElement} boton - El bot칩n pulsado.
 * @param {HTMLElement} tarjetaDiv - El contenedor visual de la tarjeta.
 */
function gestionarCompra(producto, boton, tarjetaDiv) {
    const index = jugador.inventario.findIndex(p => p.nombre === producto.nombre);

    if (index === -1) {
        if (jugador.dinero &lt; producto.precio) {
            alert("No tienes suficiente oro.");
            return;
        }
        jugador.agregarObjeto(producto);
        jugador.dinero -= producto.precio;
        boton.textContent = "Retirar";
        boton.classList.add('btn-retirar');
        tarjetaDiv.style.backgroundColor = "#c8e6c9";
    } else {
        jugador.inventario.splice(index, 1);
        jugador.dinero += producto.precio;
        if(producto.tipo === 'consumible') {
            jugador.vida -= producto.bonus;
            jugador.vidaMaxima -= producto.bonus;
        }
        boton.textContent = "Comprar";
        boton.classList.remove('btn-retirar');
        tarjetaDiv.style.backgroundColor = "";
    }

    refrescarDineroVisual();
    renderizarInventarioUI();
}

/**
 * Renderiza los iconos de los objetos comprados en los slots del footer.
 * Esto asegura que las im치genes se vean en los recuadros correspondientes.
 */
const renderizarInventarioUI = () => {
    const slots = document.querySelectorAll('.slot');
    
    slots.forEach(slot => slot.innerHTML = '');

    jugador.inventario.forEach((item, index) => {
        if (slots[index]) {
            const img = document.createElement('img');
            img.src = item.imagen;
            img.alt = item.nombre;
            img.title = item.nombre;
            slots[index].appendChild(img);
        }
    });
};

/**
 * Muestra las estad칤sticas finales calculadas antes del combate.
 */
const mostrarEstadoFinal = () => {
    document.getElementById('stat-ataque-final').textContent = jugador.obtenerAtaqueTotal();
    document.getElementById('stat-defensa-final').textContent = jugador.obtenerDefensaTotal();
    document.getElementById('stat-vida-final').textContent = jugador.vida;
    const imgEst = document.getElementById('img-jugador-estado');
    if(imgEst) imgEst.src = jugador.imagen;
};

/**
 * Muestra la lista de oponentes.
 */
const mostrarGaleriaEnemigos = () => {
    const lista = document.getElementById('lista-enemigos');
    lista.innerHTML = '';
    enemigos.forEach(enemigo => {
        const ficha = document.createElement('div');
        ficha.className = 'ficha-producto';
        ficha.innerHTML = `
            &lt;img src="${enemigo.imagen}" alt="${enemigo.nombre}">
            &lt;h4>${enemigo.nombre}&lt;/h4>
            &lt;p>Vida: ${enemigo.vida}&lt;/p>
            &lt;p>Ataque: ${enemigo.ataque}&lt;/p>
            ${enemigo instanceof Jefe ? '&lt;p style="color:red; font-weight:bold">춰JEFE!&lt;/p>' : ''}
        `;
        lista.appendChild(ficha);
    });
};

/**
 * Inicializa el carrusel de batallas.
 */
const iniciarSistemaBatallas = () => {
    enemigoActualIndex = 0;
    prepararBatalla();
};

/**
 * Prepara el escenario para un combate individual.
 */
const prepararBatalla = () => {
    const enemigo = enemigos[enemigoActualIndex];
    document.getElementById('img-enemigo-actual').src = enemigo.imagen;
    document.getElementById('img-batalla-jugador').src = jugador.imagen;
    
    actualizarBarrasVida(enemigo);
    document.getElementById('mensaje-batalla').textContent = `춰Aparece un ${enemigo.nombre}!`;
    document.getElementById('mensaje-batalla').style.color = 'black';
    document.getElementById('btn-siguiente-batalla').classList.add('oculta');

    const arena = document.querySelector('.area-combate');
    const luchadores = document.querySelectorAll('.luchador');
    arena.classList.remove('start-anim');
    luchadores.forEach(l => l.style.transition = 'none');
    setTimeout(() => {
        luchadores.forEach(l => l.style.transition = '');
        arena.classList.add('start-anim');
        setTimeout(() => combate(enemigo), 1000);
    }, 50);
};

/**
 * Bucle de combate as칤ncrono.
 */
async function combate(enemigo) {
    while (jugador.estaVivo() &amp;&amp; enemigo.estaVivo()) {
        const ataqueJ = jugador.obtenerAtaqueTotal();
        enemigo.recibirDa침o(ataqueJ);
        document.getElementById('mensaje-batalla').textContent = `Atacas a ${enemigo.nombre}: ${ataqueJ} da침o.`;
        actualizarBarrasVida(enemigo);
        if (!enemigo.estaVivo()) break;
        await esperar(1500);

        const defensaJ = jugador.obtenerDefensaTotal();
        let da침oRecibido = enemigo.ataque - defensaJ;
        if (da침oRecibido &lt; 0) da침oRecibido = 0;
        jugador.recibirDa침o(da침oRecibido);
        document.getElementById('mensaje-batalla').textContent = `${enemigo.nombre} te ataca: ${da침oRecibido} da침o.`;
        document.getElementById('mensaje-batalla').style.color = 'red';
        actualizarBarrasVida(enemigo);
        if (!jugador.estaVivo()) break;
        await esperar(1500);
        document.getElementById('mensaje-batalla').style.color = 'black';
    }
    resolverResultadoCombate(enemigo);
}

/**
 * Actualiza las barras de salud en pantalla.
 */
const actualizarBarrasVida = (enemigo) => {
    const porcJ = (jugador.vida / jugador.vidaMaxima) * 100;
    document.getElementById('vida-bar-jugador').style.width = `${Math.max(0, porcJ)}%`;
    document.getElementById('batalla-vida-jugador').textContent = jugador.vida;
    const porcE = (enemigo.vida / enemigo.vidaMaxima) * 100;
    document.getElementById('vida-bar-enemigo').style.width = `${Math.max(0, porcE)}%`; 
    document.getElementById('batalla-vida-enemigo').textContent = enemigo.vida;
};

/**
 * Gestiona el premio tras la victoria y la animaci칩n de monedas
 */
const resolverResultadoCombate = (enemigo) => {
    if (jugador.estaVivo()) {
        let ptsG = 100 + enemigo.ataque;
        let monG = (enemigo instanceof Jefe) ? 10 : 5;
        
        jugador.dinero += monG;
        jugador.sumarPuntos(ptsG);
        refrescarDineroVisual();

        document.getElementById('mensaje-batalla').innerHTML = `춰Victoria! +${ptsG} pts &lt;br> &lt;span style="font-weight: bold;">+${monG} monedas 游뿣&lt;/span>`;
        document.getElementById('mensaje-batalla').style.color = 'green';

      
        lanzarAnimacionMonedas();

        const btnSig = document.getElementById('btn-siguiente-batalla');
        btnSig.classList.remove('oculta');
        if (enemigoActualIndex === enemigos.length - 1) btnSig.textContent = "Ver Resultados Finales";
    } else {
        document.getElementById('mensaje-batalla').textContent = "Has ca칤do en la arena... Honor y Gloria.";
        setTimeout(() => {
            mostrarPantallaFinal();
            cambiarEscena('escena-fin');
        }, 3000);
    }
};

/**
 * Crea la animaci칩n de 3 monedas cayendo.
 */
const lanzarAnimacionMonedas = () => {
    const posiciones = ['25%', '50%', '75%'];
    posiciones.forEach(pos => {
        let monedaHtml = `&lt;img src="img/moneda.png" alt="moneda" class="moneda-animada" style="left: ${pos};">`;
        document.body.insertAdjacentHTML('beforeend', monedaHtml);
    });

    setTimeout(() => {
        const monedas = document.querySelectorAll('.moneda-animada');
        monedas.forEach(m => m.remove());
    }, 3000);
};

/**
 * Pasa al siguiente enemigo o termina el juego.
 */
const siguienteRonda = () => {
    enemigoActualIndex++;
    if (enemigoActualIndex &lt; enemigos.length) {
        prepararBatalla();
    } else {
        mostrarPantallaFinal();
        cambiarEscena('escena-fin');
    }
};

/**
 * Escena final de resultados y guardado en LocalStorage.
 */
const mostrarPantallaFinal = () => {
    const rangoH2 = document.getElementById('rango-final');
    const totalFinal = jugador.puntos + jugador.dinero;

    document.getElementById('resumen-puntos').textContent = jugador.puntos;
    document.getElementById('resumen-monedas').textContent = jugador.dinero;
    document.getElementById('puntuacion-final').textContent = totalFinal;

    const registro = {
        gladiador: jugador.nombre,
        puntosBatalla: jugador.puntos,
        monedasRestantes: jugador.dinero,
        puntuacionTotal: totalFinal
    };
    let ranking = JSON.parse(localStorage.getItem('ranking_gladiadores')) || [];
    ranking.push(registro);
    localStorage.setItem('ranking_gladiadores', JSON.stringify(ranking));

    const haGanadoElJuego = jugador.estaVivo() &amp;&amp; enemigoActualIndex >= enemigos.length;

    if (haGanadoElJuego) {
        rangoH2.textContent = "춰VETERANO DE LA ARENA!";
        rangoH2.style.color = "var(--color-verde-exito)";
        lanzarConfeti();
    } else {
        rangoH2.textContent = "Novato... Has ca칤do en combate.";
        rangoH2.style.color = "var(--color-rojo-sangre)";
    }
};

/**
 * Rellena la tabla HTML del ranking.
 * 
 */
const mostrarRankingEnPantalla = () => {
    const ranking = JSON.parse(localStorage.getItem('ranking_gladiadores')) || [];
    ranking.sort((a, b) => b.puntuacionTotal - a.puntuacionTotal);
    const cuerpo = document.getElementById('cuerpo-ranking');
    if (!cuerpo) return;
    
    cuerpo.innerHTML = '';

    ranking.forEach(item => {
        const fila = document.createElement('tr');

        fila.innerHTML = `
            &lt;td>${item.gladiador}&lt;/td>
            &lt;td>${item.puntosBatalla}&lt;/td>
            &lt;td>${item.monedasRestantes}&lt;/td>
            &lt;td style="font-weight:bold;">${item.puntuacionTotal}&lt;/td>
        `;
        cuerpo.appendChild(fila);
    });
};


const sembrarRankingFicticio = () => {
    let ranking = JSON.parse(localStorage.getItem('ranking_gladiadores')) || [];
    
    if (ranking.length === 0) {
        const gladiadoresLeyenda = [
            { gladiador: "Adrian", puntosBatalla: 2000, monedasRestantes: 50, puntuacionTotal: 2550 },
            { gladiador: "Diego", puntosBatalla: 1900, monedasRestantes: 30, puntuacionTotal: 2130 },
            { gladiador: "Alberto", puntosBatalla: 1800, monedasRestantes: 80, puntuacionTotal: 1880 },
            { gladiador: "Elias", puntosBatalla: 1500, monedasRestantes: 40, puntuacionTotal: 1540 },
            { gladiador: "Paco", puntosBatalla: 1200, monedasRestantes: 100, puntuacionTotal: 1300 },
            { gladiador: "Alejandro", puntosBatalla: 900, monedasRestantes: 20, puntuacionTotal: 920 },
            { gladiador: "Ronic", puntosBatalla: 500, monedasRestantes: 10, puntuacionTotal: 510 }
        ];
        localStorage.setItem('ranking_gladiadores', JSON.stringify(gladiadoresLeyenda));
    }
};

/**
 * Efecto visual de confeti.
 */
function lanzarConfeti() {
    if (window.confetti) {
        window.confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#daa520', '#b71c1c', '#ffffff'] });
    }
}

document.addEventListener('DOMContentLoaded', init);</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-constants.html">constants</a></li><li><a href="module-main.html">main</a></li></ul><h3>Classes</h3><ul><li><a href="Enemigo.html">Enemigo</a></li><li><a href="Jefe.html">Jefe</a></li><li><a href="Jugador.html">Jugador</a></li><li><a href="Mercado.html">Mercado</a></li><li><a href="Personaje.html">Personaje</a></li><li><a href="Producto.html">Producto</a></li></ul><h3>Global</h3><ul><li><a href="global.html#esperar">esperar</a></li><li><a href="global.html#formatearPrecio">formatearPrecio</a></li><li><a href="global.html#obtenerAleatorio">obtenerAleatorio</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Thu Jan 15 2026 02:52:20 GMT+0100 (hora est치ndar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
